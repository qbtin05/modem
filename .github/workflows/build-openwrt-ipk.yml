name: Build OpenWrt IPKs (SDK)

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: "OpenWrt release dir (e.g. 25.12.0-rc3, 25.12.0-rc2)"
        required: true
        default: "25.12.0-rc3"
      target:
        description: "OpenWrt target (e.g. rockchip)"
        required: true
        default: "rockchip"
      subtarget:
        description: "OpenWrt subtarget (e.g. armv8)"
        required: true
        default: "armv8"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      OPENWRT_VERSION: ${{ inputs.openwrt_version || '25.12.0-rc3' }}
      TARGET: ${{ inputs.target || 'rockchip' }}
      SUBTARGET: ${{ inputs.subtarget || 'armv8' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install host deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential gawk gcc-multilib flex bison gettext \
            libncurses-dev libssl-dev python3 python3-pyelftools \
            rsync unzip file wget curl ca-certificates zstd xz-utils

      - name: Resolve SDK filename & download (with sha256 verify)
        id: sdk
        shell: bash
        run: |
          set -euo pipefail
          BASE_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/"
          echo "BASE_URL=$BASE_URL"

          # Find the SDK tarball name from sha256sums (more robust than hardcoding gcc/musl versions)
          SDK_FILE="$(curl -fsSL "${BASE_URL}sha256sums" | awk '/openwrt-sdk-.*Linux-x86_64\.tar\.(zst|xz)$/{sub(/^\*/, "", $2); print $2; exit}')"
          if [[ -z "${SDK_FILE}" ]]; then
            echo "ERROR: Could not find SDK tarball in sha256sums at: ${BASE_URL}"
            exit 1
          fi
          echo "SDK_FILE=${SDK_FILE}"
          echo "sdk_file=${SDK_FILE}" >> "$GITHUB_OUTPUT"

          curl -fL "${BASE_URL}${SDK_FILE}" -o "${SDK_FILE}"
          curl -fL "${BASE_URL}sha256sums" -o "sha256sums"

          # Verify checksum
          grep -E " \*?${SDK_FILE}$" sha256sums | sha256sum -c -

      - name: Extract SDK
        shell: bash
        run: |
          set -euo pipefail
          SDK_FILE="${{ steps.sdk.outputs.sdk_file }}"
          # tar.zst needs zstd; tar.xz needs xz-utils (installed above)
          if [[ "${SDK_FILE}" == *.tar.zst ]]; then
            tar -I zstd -xf "${SDK_FILE}"
          else
            tar -xf "${SDK_FILE}"
          fi
          SDK_DIR="$(ls -d openwrt-sdk-*/ | head -n1)"
          echo "SDK_DIR=${SDK_DIR}" >> "$GITHUB_ENV"
          echo "Using SDK_DIR=${SDK_DIR}"

      - name: Copy local packages into SDK
        shell: bash
        run: |
          set -euo pipefail
          cd "${SDK_DIR}"

          # Copy every top-level dir from this repo that looks like an OpenWrt package:
          # - is a directory
          # - contains a Makefile
          # Exclude common non-package dirs if any appear
          shopt -s nullglob
          COPIED_PACKAGES=""
          for d in ../*/ ; do
            name="$(basename "$d")"
            [[ "$name" == ".github" ]] && continue
            [[ "$name" == ".git" ]] && continue
            [[ "$name" == "docs" ]] && continue
            [[ "$name" == "openwrt-sdk-"* ]] && continue

            if [[ -f "$d/Makefile" ]]; then
              echo "Adding package: $name"
              rm -rf "package/${name}"
              rsync -a --delete "$d/" "package/${name}/"
              COPIED_PACKAGES="${COPIED_PACKAGES}${name} "
            fi
          done
          
          # Export list of copied packages for later steps
          COPIED_PACKAGES="${COPIED_PACKAGES% }"  # Trim trailing space
          echo "COPIED_PACKAGES=${COPIED_PACKAGES}" >> "$GITHUB_ENV"
          echo "Copied packages: ${COPIED_PACKAGES:-none}"

      - name: Update feeds & defconfig
        shell: bash
        run: |
          set -euo pipefail
          cd "${SDK_DIR}"

          # Retry logic for feeds update (OpenWrt git servers can be flaky)
          MAX_RETRIES=3
          RETRY_COUNT=0
          LAST_OUTPUT=""

          while (( RETRY_COUNT < MAX_RETRIES )); do
            echo "Attempting feeds update (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."

            # Capture output to check for transient errors
            if LAST_OUTPUT=$(./scripts/feeds update -a 2>&1); then
              echo "Feeds update succeeded"
              break
            else
              EXIT_CODE=$?
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # Check if error is likely transient (503, connection issues, RPC failures)
              if echo "$LAST_OUTPUT" | grep -qE "(error.*503|HTTP 503|RPC failed|hung up unexpectedly|Connection.*reset|timed out)"; then
                if (( RETRY_COUNT < MAX_RETRIES )); then
                  echo "Transient error detected, retrying in 10 seconds..."
                  sleep 10
                else
                  echo "Feeds update failed after $MAX_RETRIES attempts with transient errors"
                  echo "Last output:"
                  echo "$LAST_OUTPUT"
                  exit 1
                fi
              else
                # Non-transient error, fail immediately
                echo "Feeds update failed with non-transient error (exit code $EXIT_CODE)"
                echo "Output:"
                echo "$LAST_OUTPUT"
                # Ensure we exit with a non-zero code
                exit ${EXIT_CODE:-1}
              fi
            fi
          done

          ./scripts/feeds install -a
          make defconfig

      - name: Build all detected local packages
        shell: bash
        run: |
          set -euo pipefail
          cd "${SDK_DIR}"

          # Check if any packages were copied
          if [[ -z "${COPIED_PACKAGES}" ]]; then
            echo "No local packages to build. Skipping build step."
            exit 0
          fi

          # Build only the packages we copied
          read -ra PKGS <<< "${COPIED_PACKAGES}"
          
          echo "Packages to build:"
          printf " - %s\n" "${PKGS[@]}"

          # Build each package; keep going to show which ones fail (optional)
          FAILED=0
          for p in "${PKGS[@]}"; do
            echo "::group::build $p"
            if ! make "package/${p}/compile" -j"$(nproc)" V=s; then
              echo "FAILED: $p"
              FAILED=1
            fi
            echo "::endgroup::"
          done

          if [[ "$FAILED" -ne 0 ]]; then
            echo "One or more packages failed. Check logs above."
            exit 1
          fi

      - name: Collect IPKs
        if: env.COPIED_PACKAGES != ''
        shell: bash
        run: |
          set -euo pipefail
          cd "${SDK_DIR}"
          mkdir -p ../artifacts
          find bin/packages -type f -name "*.ipk" -print -exec cp -v {} ../artifacts/ \; || true
          (cd ../artifacts && ls -lah) || echo "No artifacts to collect"

      - name: Upload artifacts (ipk)
        if: env.COPIED_PACKAGES != ''
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ipk-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}
          path: artifacts/*.ipk
          if-no-files-found: warn
